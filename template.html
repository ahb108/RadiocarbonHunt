<!-- Add scripts etc -->
<script src="https://code.jquery.com/ui/1.8.1/jquery-ui.min.js" type="text/javascript"
xmlns="http://www.w3.org/1999/html"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.12.6/handsontable.full.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.2.1/ol.min.js" type="text/javascript"></script>
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

<!-- Add style sheets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.2.1/ol.css" type="text/css">
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.12.6/handsontable.full.min.css">

<!-- Start of the survey modals -->
<div id="survey" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title">Do you want to help us?</h4>
			</div>
			<div class="modal-body">
				Thanks for contributing one task for the project. We are interested in knowing how you found out about
				us.
				<strong>Could you please answer two questions in a short survey?</strong>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success"
				href="https://docs.google.com/forms/d/1Kgw8cvcufm-77PC2t_PL_b4y1_Tb9wJseimmb3cQIn4/viewform?embedded=true">Of
				course!
				Take me to the survey!</a>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="survey25" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title">Congratulations for completing 25 tasks!</h4>
			</div>
			<div class="modal-body">
				Thanks for contributing 25 tasks for the project. Now that you have been using MicroPasts for a while,
				we would like to know how you found it. <strong>Could you please answer a few questions in a short
				survey?</strong>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success"
				href="https://docs.google.com/forms/d/1uczUGGYbrQ2FQfTtM8j4vfGr2qwcCMW6PLwzfvZZ6kI/viewform?embedded=true">Of
				course! Take me to the survey!</a>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- End of the survey modals -->

<!-- Browser not compatible message -->
<div style="display:none;margin-top:15px; height:500px;" id="oldbrowser" class="row">
	<!-- Success and Error Messages for the user -->
	<div  class="col-md-8 col-md-offset-1 alert alert-info">
		<strong>Sorry, but your browser does not support the current application. If you want to contribute, please,
		upgrade to a modern web browser like the open source and free alternative <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> or <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a></strong>.
	</div>
</div>
<!-- End of Row -->
<!-- end of browser -->

<!-- Start of messages -->
<div style="margin-top:15px;">
	<div id="success" class="alert alert-success" style="display:none;">
		<strong>Well done!</strong> You have successfully submitted your contribution. Here is another to try if you wish!
	</div>
	<div id="loading" class="alert alert-info" style="display:none;">
		<img src="/static/img/loading.gif">Loading next task...
	</div>
	<div id="taskcompleted" class="alert alert-info" style="display:none;">
		<strong>The task has been completed!</strong> Thanks a lot!
	</div>
	<div id="finish" class="alert alert-success" style="display:none;">
		<h2>Congratulations!</h2>
		<p>
			You have participated in all available tasks!
		</p>
		<div class="alert-actions">
			<a class="btn-default btn" href="/">Go back to the home page</a>
			<a class="btn-default btn" href="/app">or, have a look at our
			other applications</a>
		</div>
	</div>
	<div id="error" class="alert alert-error" style="display:none;">
		<a class="close">×</a>
		<strong>Error!</strong> Something went wrong, please contact the site administrators
	</div>
</div>
<!-- End Success and Error Messages for the user -->

<!--
Task DOM for loading the S3 Images
It uses the class="skeleton" to identify the elements that belong to the
task.
-->
<div class="row skeleton" id="rcData">
	<div class="row">
		<div class="btn-group">
			<button class="btn btn-info btn-xs" data-toggle="modal" data-target="#myModal">
				<i
				class="glyphicon glyphicon-eye-open"></i> Tutorial
			</button>
			<a class="btn btn-info btn-xs" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top"
			title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i
			class="glyphicon glyphicon-book"></i> Community Help</a>
		</div>
	</div>
	<!-- The pdf section -->
	<div class="row">
		<div id="mypdf">
			<iframe
			id = "pdfImage"
			width = "75%" height="400px" class="pdf" src="http://ads-greylit.s3.amazonaws.com/aocarcha1-47015_2.pdf"></iframe>
		</div>
	</div>
	<!-- End of pdf section -->
	<!-- The data entry section using html table -->
	<div class="row">
		<h4>Input any radiocarbon dates in this report:</h4>
		<div id="rcTable" class="handsontable"></div>
		<button class="btn btn-success btn-answer" value='Yes'>
			Submit you dates
		</button>
		<!-- Feedback items for the user -->
		<p>
			You are working now on task: <span id="task-id" class="label label-warning">#</span>
		</p>
		<p>
			You have completed: <span id="done" class="label label-info"></span> tasks from <!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</p>
		<div class="progress progress-striped">
			<div id="progress" rel="tooltip" title="#" class="progress-bar" role="progressbar" style="width: 0%;"></div>
		</div>
		<!-- End of feedback row -->
	</div>
	<!-- End of the section -->
</div>
<!-- End of DOM Skeleton row -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- Modal header -->
			<div class="modal-header">
				<h3>Transcribing the Worthington Smith notebooks</h3>

			</div>

			<!-- Step 1 of the tutorial -->
			<div id="0" class="modal-body" style="display:none">
				<p>
					This application is very simple and is a transcription based exercise. Our team would like you to
					write down exactly what you see on each line of the notepad into the table displayed below the zooming image.
				</p>

				<p>
					Each entry in the note book is similar, 7 fields:
				</p>
				<ul class="list-group">
					<li>
						Entry number
					</li>
					<li>
						Date of discovery
					</li>
					<li>
						Description of the discovery
					</li>
					<li>
						Length in inches
					</li>
					<li>
						Width in inches
					</li>
					<li>
						Weight in pounds
					</li>
					<li>
						Weight in ounces
					</li>
				</ul>
			</div>

			<!-- Step 2 of the tutorial -->
			<div id="1" class="modal-body" style="display:none">
				<p>
					The image that we would like you to transcribe for us, starts at the top of the page and can be scrolled
					up and down, and zoomed in and out to read more of the contents. We hope that this interface allows you to
					work on the image concurrently with the text table below the image container.
				</p>

				<p>
					The table starts off with just 6 rows but will add another automatically when you get to the bottom, up
					to a maximum of 20 rows.
				</p>

				<p>
					The image is contained within an interface that allows you to zoom in and out, and even go full screen.
					Try the controls out, you won't break anything!
				</p>
			</div>

			<!-- Step 2 of the tutorial -->
			<div id="2" class="modal-body" style="display:none">
				<p>
					As in the Bronze Age index transcription applications, some abbreviations are used. If you see the sign in the image below, it means 'ditto'.
					So please enter the same as the previous line's entry.
				</p>
				<img src="http://micropasts.org/wp-content/uploads/2015/03/MicroPasts-·-Project-Transcribing-the-Worthington-George-Smith-catalogue-·-Contribute.png">
				<p>
					As this is an antiquarian notebook, the measurements are not metric and are in imperial measures. When transcribing, do not
					attempt to convert the weights or dimensions. Instead please just enter as seen. If you see 3 1/4, then please enter as such.
					The project team will do the conversions.
				</p>
			</div>
			<!-- End of stepped modal body -->

			<!-- Modal footer -->
			<div class="modal-footer">
				<a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
				<a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
				<button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none"/>
				</button>
				<i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
			</div>
		</div>
	</div>
</div>

<!-- Client side scripts -->
<script>
	// Quick fix for IE8
	Modernizr.load({
		test : window.JSON,
		nope : '/static/js/vendor/json2.min.js'
	}); 
</script>

<!-- Step through modals -->
<script type="text/javascript">
	var step = -1;
	function showStep(action) {
		$("#" + step).hide();
		if (action == 'next') {
			step = step + 1;
		}
		if (action == 'prev') {
			step = step - 1;
		}
		if (step == 0) {
			$("#prevBtn").hide();
		} else {
			$("#prevBtn").show();
		}

		if (step == 2) {
			$("#nextBtn").hide();
			$("#startContrib").show();
		}
		$("#" + step).show();
	}

	showStep('next');
	$("#modal").modal('show'); 
</script>

<!-- Load user progress -->
<script>
	function loadUserProgress() {
		pybossa.userProgress('RadiocarbonHunt').done(function(data) {
			console.log(data);
			console.log("Total answers done for user: " + data.done);
			if ((data.done == 1) && ($.cookie('surveyRadiocarbonHunt') == undefined)) {
				$("#survey").modal('show');
				$.cookie('surveyRadiocarbonHunt', 'shown', {
					path : '/'
				});
			}
			if ((data.done >= 25) && ($.cookie('survey25RadiocarbonHunt') == undefined)) {
				$("#survey25").modal('show');
				$.cookie('survey25RadiocarbonHunt', 'shown', {
					path : '/'
				});
			}
			var pct = Math.round((data.done * 100) / data.total);
			$("#progress").css("width", pct.toString() + "%");
			$("#progress").attr("title", pct.toString() + "% completed!");
			$("#progress").tooltip({
				'placement' : 'left'
			});
			$("#total").text(data.total);
			$("#done").text(data.done);
			$('a[rel]').tooltip({
				'placement' : 'left'
			});
		});
	}


	pybossa.taskLoaded(function(task, deferred) {
		if (! $.isEmptyObject(task)) {
			loadUserProgress();
			deferred.resolve(task);
		} else {
			deferred.resolve(task);
		}
	});
	$(window).resize(function() {
		console.log('Window resized');
	});

	pybossa.presentTask(function(task, deferred) {
		if (!$.isEmptyObject(task)) {
			$("#question").html(task.info.question);
			$('#task-id').html(task.id);

			var thispdf = task.info.url_b

			var data = [[]];
			var config = {
				data : data,
				minRows : 6,
				minCols : 7,
				minSpareRows : 1,
				minSpareCols : 0,
				maxRows : 20,
				autoWrapRow : true,
				autoWrapCol : true,
				autoColumnSize : true,
				colHeaders : ['LabCode', 'AgeBP', 'Error', 'dC13', 'Material', 'SiteContext', 'Comments'],
				contextMenu : ['row_below', 'remove_row', 'undo', 'redo'],
				stretchH : 'all'
			};
			$("#rcTable").handsontable(config);

			$('.btn-answer').off('click').on('click', function(evt) {
				evt.preventDefault();
				var answer = $(evt.target).attr("value");
				if ( typeof answer != 'undefined') {
					task.answer = $("#rcData").serializeJSON();
					console.log(task.answer);
					var handsontable = $("#rcTable").data('handsontable');
					var data = handsontable.getData();
					console.log(data);
					task.answer = data;
					console.log(task.answer);
					pybossa.saveTask(task.id, task.answer).done(function() {
						$("html, body").animate({
							scrollTop : 0
						}, "slow");
						$("#success").fadeIn(500).fadeOut(500);
						$("#loading").fadeIn(500).fadeOut(500);
						mypdf.setTarget(null);
						deferred.resolve();
					});
				} else {
					$("#error").show();
				}
			});
			$("#loading").hide();
		} else {
			$(".skeleton").hide();
			$("#loading").hide();
			$("#finish").fadeIn(500);
		}
	});
	pybossa.run('RadiocarbonHunt'); 
</script>

<style type="text/css">
	#mypdf:-moz-full-screen {
		height: 100%;
	}
	#mypdf:-webkit-full-screen {
		height: 100%;
	}
	#mypdf:-ms-fullscreen {
		height: 100%;
	}
	#mypdf:full-screen {
		height: 100%;
	}
	#rcTable {
		width: 100%;
	}
	.btn-answer {
		margin-top: 10px;
		margin-bottom: 10px;
	}
	.btn-group {
		margin-bottom: 0px
	}
</style>